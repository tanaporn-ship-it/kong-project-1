<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School RFID Attendance V4 (Full Features)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 950px; margin: 2rem auto; padding: 0 1rem; background-color: #f0f2f5; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1, h2, h3 { color: #2c3e50; text-align: center; margin-bottom: 1.5rem; }
        
        /* Input Styling */
        .form-group { margin-bottom: 10px; }
        input[type="text"], select, input[type="file"] { width: 100%; padding: 12px; margin: 5px 0; border: 2px solid #e1e4e8; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        input[type="text"]:focus, select:focus { border-color: #4CAF50; outline: none; }
        
        button { width: 100%; padding: 14px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.2s; }
        button:hover { background-color: #45a049; }

        /* Secondary Buttons */
        .btn-cancel { background-color: #757575; margin-top: 10px; display: none; }
        .btn-cancel:hover { background-color: #616161; }
        
        .btn-edit { background-color: #2196F3; padding: 5px 10px; width: auto; font-size: 0.85em; margin-right: 5px; }
        .btn-edit:hover { background-color: #1976D2; }

        .btn-delete { background-color: #ef5350; padding: 5px 10px; width: auto; font-size: 0.85em; }
        .btn-delete:hover { background-color: #d32f2f; }
        
        /* Status Messages */
        #status { margin-top: 1rem; padding: 15px; border-radius: 6px; text-align: center; display: none; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #4CAF50; color: white; border-radius: 6px 6px 0 0; }
        tr:last-child td { border-bottom: none; }
        
        /* Admin Table Specifics */
        .admin-table th { background-color: #607d8b; }

        /* Profile Image Styles */
        .profile-pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .no-pic { width: 45px; height: 45px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #999; }

        /* Admin Section Style */
        .admin-box { border: 2px dashed #cbd5e0; background-color: #f8fafc; }
        .admin-title { color: #64748b; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1.5px; font-weight: bold; margin-bottom: 15px; }
        
        /* Grid for Form */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        
        /* Subject Selector Style */
        .subject-box { background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; margin-bottom: 20px; text-align: center; }
        .subject-box label { color: #1565c0; font-weight: bold; margin-right: 10px; }
        .subject-box select { width: auto; padding: 8px; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè´ Daily Attendance Check-in</h1>
    
    <div class="subject-box">
        <label>üìö Current Subject:</label>
        <select id="attendanceSubject">
            <option value="Morning Assembly">Morning Assembly</option>
            <option value="Mathematics">Mathematics</option>
            <option value="Science">Science</option>
            <option value="English">English</option>
            <option value="History">History</option>
            <option value="Physical Ed">Physical Ed</option>
        </select>
    </div>
    
    <p style="text-align:center; color:#666;">Click the box below and scan your card.</p>
    <input type="text" id="attendanceInput" placeholder="Scan RFID tag here..." autofocus autocomplete="off">
    
    <div id="status"></div>

    <h3>üïí Live Attendance Log</h3>
    <table id="attendanceTable">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Time</th>
                <th>Name</th>
                <th>Subject</th>
                <th>Grade</th>
                <th>Sex</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="container admin-box">
    <div class="admin-title">Teacher Control Panel</div>
    <h2 id="formTitle">‚ûï Register New Student</h2>
    
    <div class="form-grid">
        <input type="text" id="regName" placeholder="Full Name">
        <select id="regSex">
            <option value="" disabled selected>Sex</option>
            <option value="Male">Male ‚ôÇÔ∏è</option>
            <option value="Female">Female ‚ôÄÔ∏è</option>
        </select>
        <select id="regGrade">
            <option value="" disabled selected>Grade</option>
            <option value="Grade 1">Grade 1</option>
            <option value="Grade 2">Grade 2</option>
            <option value="Grade 3">Grade 3</option>
            <option value="Grade 4">Grade 4</option>
            <option value="Grade 5">Grade 5</option>
            <option value="Grade 6">Grade 6</option>
            <option value="Teacher">Teacher</option>
        </select>
    </div>

    <label style="display:block; margin-top:10px; font-size:0.9em; color:#555;">Profile Photo:</label>
    <input type="file" id="regPhoto" accept="image/*">

    <input type="text" id="regTag" placeholder="Click here & Scan Card..." style="background-color: #fffde7;">
    
    <button id="btnSave" onclick="registerStudent()">Save Student Profile</button>
    <button id="btnCancel" class="btn-cancel" onclick="resetForm()">Cancel Edit</button>

    <hr style="margin: 30px 0; border:0; border-top:1px solid #ddd;">

    <h3>üìã Registered Students Database</h3>
    <table class="admin-table">
        <thead>
            <tr>
                <th>Photo</th>
                <th>Name</th>
                <th>Sex</th>
                <th>Grade</th>
                <th>Tag ID</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="studentListBody"></tbody>
    </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, setDoc, deleteDoc, doc, onSnapshot, query, orderBy, limit, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDiymbu_dpuF0HYO8s-SLya5KU3sCdIpC0",
    authDomain: "student-rfid-attendanc.firebaseapp.com",
    projectId: "student-rfid-attendanc",
    storageBucket: "student-rfid-attendanc.firebasestorage.app",
    messagingSenderId: "406495228894",
    appId: "1:406495228894:web:58da2ea9d60b331d9ae34f",
    measurementId: "G-TD81T46BFX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- 1. HELPER: IMAGE TO BASE64 ---
  const toBase64 = file => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
  });

  // --- 2. STUDENT DIRECTORY (Local Cache + Admin Table) ---
  let studentDirectory = {}; 

  onSnapshot(collection(db, "students"), (snapshot) => {
      const tbody = document.getElementById("studentListBody");
      tbody.innerHTML = ""; // Clear table
      studentDirectory = {}; // Reset cache

      snapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const id = docSnap.id;
          
          // Store for lookup
          studentDirectory[id] = {
              name: d.name,
              grade: d.grade || "N/A",
              sex: d.sex || "N/A",
              photo: d.photo || null
          };

          // Render Admin Table Row
          let imgHtml = `<div class="no-pic">?</div>`;
          if (d.photo) imgHtml = `<img src="${d.photo}" class="profile-pic">`;

          let sexIcon = d.sex === 'Male' ? '‚ôÇÔ∏è' : (d.sex === 'Female' ? '‚ôÄÔ∏è' : '');

          const row = `
            <tr>
                <td>${imgHtml}</td>
                <td>${d.name}</td>
                <td>${d.sex || '-'} ${sexIcon}</td>
                <td>${d.grade}</td>
                <td style="font-family:monospace; color:#888; font-size:0.85em;">${id}</td>
                <td>
                    <button class="btn-edit" onclick="editStudent('${id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteStudent('${id}', '${d.name}')">Delete</button>
                </td>
            </tr>`;
          tbody.innerHTML += row;
      });
  });

  // --- 3. REGISTER / UPDATE STUDENT ---
  window.registerStudent = async function() {
      const name = document.getElementById('regName').value.trim();
      const sex = document.getElementById('regSex').value;
      const grade = document.getElementById('regGrade').value;
      const tagId = document.getElementById('regTag').value.trim();
      const photoFile = document.getElementById('regPhoto').files[0];

      if (!name || !tagId || !grade || !sex) {
          alert("Please fill in Name, Sex, Grade, and Scan a Tag!");
          return;
      }

      // Handle Image
      let photoBase64 = null;
      if (photoFile) {
          if (photoFile.size > 500 * 1024) { alert("Photo too large (>500KB)"); return; }
          photoBase64 = await toBase64(photoFile);
      } else {
          // If editing and no new photo, keep existing
          if (studentDirectory[tagId]) photoBase64 = studentDirectory[tagId].photo;
      }

      try {
          // merge: true keeps old fields if we don't overwrite them
          await setDoc(doc(db, "students", tagId), {
              name: name,
              sex: sex,
              grade: grade,
              photo: photoBase64,
              registeredAt: serverTimestamp()
          }, { merge: true });
          
          alert(`‚úÖ Student Saved: ${name}`);
          resetForm();
      } catch (e) {
          console.error(e);
          alert("‚ùå Error saving student.");
      }
  }

  // --- 4. EDIT FUNCTION ---
  window.editStudent = function(id) {
      const s = studentDirectory[id];
      if(!s) return;

      // Fill Form
      document.getElementById('regName').value = s.name;
      document.getElementById('regSex').value = s.sex;
      document.getElementById('regGrade').value = s.grade;
      document.getElementById('regTag').value = id;
      
      // UI Changes for Edit Mode
      document.getElementById('regTag').readOnly = true; // Cannot change ID
      document.getElementById('regTag').style.backgroundColor = "#e0e0e0";
      document.getElementById('formTitle').innerText = "‚úèÔ∏è Edit Student Details";
      document.getElementById('btnSave').innerText = "Update Student";
      document.getElementById('btnCancel').style.display = "block";
      
      // Scroll to form
      document.querySelector('.admin-box').scrollIntoView({behavior: 'smooth'});
  }

  // --- 5. DELETE FUNCTION ---
  window.deleteStudent = async function(id, name) {
      if(confirm(`‚ö†Ô∏è Are you sure you want to DELETE ${name}?\nThis cannot be undone.`)) {
          try {
              await deleteDoc(doc(db, "students", id));
          } catch(e) {
              alert("Error deleting: " + e.message);
          }
      }
  }

  // Reset Form
  window.resetForm = function() {
      document.getElementById('regName').value = '';
      document.getElementById('regSex').value = '';
      document.getElementById('regGrade').value = '';
      document.getElementById('regTag').value = '';
      document.getElementById('regPhoto').value = '';
      
      // Reset UI
      document.getElementById('regTag').readOnly = false;
      document.getElementById('regTag').style.backgroundColor = "#fffde7";
      document.getElementById('formTitle').innerText = "‚ûï Register New Student";
      document.getElementById('btnSave').innerText = "Save Student Profile";
      document.getElementById('btnCancel').style.display = "none";
  }

  // --- 6. ATTENDANCE LOGIC ---
  const attendanceInput = document.getElementById('attendanceInput');
  const statusDiv = document.getElementById('status');

  attendanceInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
          const tagId = attendanceInput.value.trim();
          if (tagId) {
              await markAttendance(tagId);
              attendanceInput.value = ''; 
          }
      }
  });

  async function markAttendance(id) {
      const student = studentDirectory[id];
      const subject = document.getElementById('attendanceSubject').value; // Get selected subject

      // Prepare data
      const studentName = student ? student.name : "Unknown";
      const studentGrade = student ? student.grade : "--";
      const studentSex = student ? student.sex : "--";
      const studentPhoto = student ? student.photo : null;

      try {
          await addDoc(collection(db, "attendance"), {
              tag_id: id,
              student_name: studentName,
              student_grade: studentGrade,
              student_sex: studentSex,
              student_photo: studentPhoto,
              subject: subject, // Save the subject
              timestamp: serverTimestamp()
          });
          
          if(student) {
              showStatus(`‚úÖ ${studentName} checked into ${subject}!`, "success");
          } else {
              showStatus(`‚ö†Ô∏è Unregistered Tag: ${id}`, "error");
          }
      } catch (e) {
          console.error(e);
          showStatus("‚ùå System Error.", "error");
      }
  }

  function showStatus(msg, type) {
      statusDiv.textContent = msg;
      statusDiv.className = type;
      statusDiv.style.display = 'block';
      setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
  }

  // --- 7. LIVE ATTENDANCE TABLE ---
  const q = query(collection(db, "attendance"), orderBy("timestamp", "desc"), limit(10));
  
  onSnapshot(q, (snapshot) => {
      const tbody = document.querySelector('#attendanceTable tbody');
      tbody.innerHTML = ''; 
      
      snapshot.forEach((doc) => {
          const data = doc.data();
          let dateStr = "Just now";
          if (data.timestamp) dateStr = data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

          let imgHtml = `<div class="no-pic">?</div>`;
          if (data.student_photo) imgHtml = `<img src="${data.student_photo}" class="profile-pic">`;

          const row = `<tr>
              <td>${imgHtml}</td>
              <td>${dateStr}</td>
              <td style="font-weight:bold; color:#333;">${data.student_name}</td>
              <td><span style="background:#e3f2fd; color:#1565c0; padding:2px 8px; border-radius:4px; font-size:0.9em;">${data.subject || "General"}</span></td>
              <td>${data.student_grade}</td>
              <td>${data.student_sex || '-'}</td>
          </tr>`;
          tbody.innerHTML += row;
      });
  });
</script>

</body>
</html>
